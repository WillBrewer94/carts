pico-8 cartridge // http://www.pico-8.com
version 15
__lua__
-- sport prototype --
-- will brewer --

-- game variables --
players={}
scene=0
ground_tag=0
platf_tag=0
jump_power=0.8

-- constructors --
------------------
function make_actor(x, y)
	-- player 1 object --
 actor={}
 actor.x=x --x pos
 actor.y=y --y pos
 actor.dx=0 --x velocity
 actor.dy=0 --y velocity
 actor.speed=4 --movement spd
 actor.sprt=17 --sprite index
 actor.grav=0.05 --gravity
 actor.inertia=0.8
 actor.accel=0.08
 actor.tag=0
 
 actor.w=0.4
 actor.h=0.4
 
 add(players, actor)
 return actor
end

-- base engine methods --
-------------------------
function _init()
	cls()
	local ball=make_actor(8,4)
	local player=make_actor(10,4)
	player.tag = 1
	scene=1
end

function _update()
	if scene==0 then
		title_update()
	elseif scene==1 then
		game_update()
	end
end

function _draw()
	if scene==0 then
		title_draw()
	elseif scene==1 then
		game_draw()
	end
end

-- state machine methods --
---------------------------
function title_update()
	if btnp(5) then
		scene=1
	end
end

function title_draw()
 cls()
	print("goal!",50,64)
	print("press x to restart",25,80)
end

function game_update()
	--parse input
	input()
	
	--calcualte physics
 physics()
 
 --calculate collision
 collision()
end

function game_draw()
 cls()
	map(0,0,0,0)
	
	--draw actors
	for a in all(players) do
		local sx=(a.x * 8) - 4
		local sy=(a.y * 8) - 4
		spr(a.sprt,sx,sy,1,1,false,false)
	end
	
	print(players[1].dy, 0, 0)
end

-- helper methods --
--------------------
function input()
	local player1=players[1]
 player1.sprt=18
 player1.accel=0.2
	local player2=players[2]
	
	--player 1 input
	if btn(0,0) then --move left
		player1.dx-=player1.accel
	elseif btn(1,0) then --move right
		player1.dx+=player1.accel
	end
	
	--player 2 input
	if btn(0,1) then --move left
		player2.dx-=player2.accel
	elseif btn(1,1) then --move right
		player2.dx+=player2.accel
	end
	if btn(5,0) then
		player1.dy=-jump_power
	end
end

function physics()
	
	for a in all(players) do
 	--apply gravity
 	a.dy += a.grav
 	
 	--apply inertia
 	a.dx *= a.inertia
 end
end

function collision()
	for a in all(players) do
		
		if solid_actor(a,a.dx, 0) then
			a.dx *= -1
		end
				
 	--move player x direction
 	if not is_solid(a, a.dx, 0) then
   a.x += a.dx
  else
   a.dx *= -1
  end
 
 	--move player y direciton
 	if not is_solid(a, 0, a.dy) then
   a.y += a.dy
  elseif a.tag == 1 then
   a.dy = -jump_power
  else
  	a.dy = 0
  end
 end
end

-- collision functions --
-------------------------
function solid(x, y)
 -- grab the cell value
 val=mget(x, y)
 
 -- check if flag 1 is set (the
 -- orange toggle button in the 
 -- sprite editor)
 return fget(val, 1)
 
end

--checks actors and tile collision
function is_solid(a, dx, dy)
 if solid_area(a.x+dx,a.y+dy,
    a.w,a.h) then
    return true end
 return solid_actor(a, dx, dy) 
end

function solid_area(x,y,w,h)

 return 
  solid(x-w,y-h) or
  solid(x+w,y-h) or
  solid(x-w,y+h) or
  solid(x+w,y+h)
end

function solid_actor(a, dx, dy)
 for a2 in all(players) do
  if a2 != a then
   local x=(a.x+dx) - a2.x
   local y=(a.y+dy) - a2.y
   if ((abs(x) < (a.w+a2.w)) and
      (abs(y) < (a.h+a2.h)))
   then 
    
    -- moving together?
    -- this allows actors to
    -- overlap initially 
    -- without sticking together    
    if (dx != 0 and abs(x) <
        abs(a.x-a2.x)) then
     v=a.dx + a2.dy
     a.dx = v/2
     a2.dx = v/2
     return true 
    end
    
    if (dy != 0 and abs(y) <
        abs(a.y-a2.y)) then
     v=a.dy + a2.dy
     a.dy=v/2
     a2.dy=v/2
     return true 
    end
    
    --return true
    
   end
  end
 end
 return false
end
__gfx__
00000000666666668888888875555557555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666668888888857555575555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666666668888888855755755555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000666666668888888855577555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000666666668888888855577555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666666668888888855755755555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666668888888857555575555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666668888888875555557555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000059999500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000995995990ffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000995995990f0fff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000995995990ffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000009959959900f99f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000059999500099990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009999000080080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000040404040404000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000040404040404000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000040403030404000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000040403030404000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020000000035360404393a000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020000000005060404090a000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010000000015160404191a000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010000000025260404292a000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010000000005060404090a000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010000000005060404090a000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010000000015160404191a000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010000000025260404292a000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010000000035360404393a000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
